{% extends 'base.html' %}

{% block title %}Create Ring Signature - Ring Signature System{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-pen"></i> Create Ring Signature</h2>
                <a href="{% url 'verifier' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-check-circle"></i> Verify Signature
                </a>
            </div>
    
            {% if messages %}
            <div class="messages">
                {% for message in messages %}
                <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            </div>
            {% endif %}
    
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-pen"></i> Sign Message</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" action="{% url 'sign' %}" id="signatureForm">
                        {% csrf_token %}
                        
                        <!-- Message Input -->
                        <div class="mb-4">
                            <label for="id_message" class="form-label">
                                <i class="bi bi-chat-text"></i> Message to Sign
                            </label>
                            <textarea name="message" id="id_message" class="form-control" rows="3" 
                                      placeholder="Enter the message you want to sign..."></textarea>
                            <div class="form-text">Leave empty if uploading a PDF file below.</div>
                        </div>
                        
                        <!-- PDF Upload -->
                        <div class="mb-4">
                            <label for="id_pdf_file" class="form-label">
                                <i class="bi bi-file-earmark-pdf"></i> Or Upload PDF File
                            </label>
                            <input type="file" name="pdf_file" id="id_pdf_file" class="form-control" accept="application/pdf">
                            <div class="form-text">If you upload a PDF, its hash will be signed instead of the text message.</div>
                        </div>
                        
                        <!-- Ring Members Section -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <label class="form-label mb-0">
                                    <i class="bi bi-people"></i> Ring Members
                                </label>
                                <button type="button" class="btn btn-success btn-sm" onclick="addRingMember()">
                                    <i class="bi bi-plus-circle"></i> Add Member
                                </button>
                            </div>
                            
                            <div id="ringMembersContainer">
                                <!-- Ring members will be added here dynamically -->
                            </div>
                            
                            <div class="alert alert-info" id="noMembersAlert" style="display: none;">
                                <i class="bi bi-info-circle"></i> No ring members added yet. Click "Add Member" to get started.
                            </div>
                        </div>
                        
                        <!-- Signer Selection -->
                        <div class="mb-4" id="signerSelection" style="display: none;">
                            <label class="form-label">
                                <i class="bi bi-person-check"></i> Select the Actual Signer
                            </label>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> 
                                <strong>Important:</strong> Select which member is the actual signer. 
                                This member must provide their private key below.
                            </div>
                            <div id="signerOptions">
                                <!-- Signer options will be populated here -->
                            </div>
                        </div>
                        
                        <!-- Private Key Input -->
                        <div class="mb-4" id="privateKeySection" style="display: none;">
                            <label for="private_key" class="form-label">
                                <i class="bi bi-key"></i> Private Key of the Signer
                            </label>
                            <textarea class="form-control" id="private_key" name="private_key" rows="6" 
                                      placeholder="Enter the private key of the selected signer in PEM format..." required></textarea>
                            <div class="form-text">
                                <i class="bi bi-shield-check"></i> 
                                This private key will be used to create the signature. It must match the public key of the selected signer.
                            </div>
                        </div>
                        
                        <!-- Hidden field for member data -->
                        <input type="hidden" name="member_data" id="memberData" value="[]">
                        <input type="hidden" name="signer_index" id="signerIndex" value="0">
                        
                        <!-- Form Status Message -->
                        <div class="alert alert-info" id="formStatusMessage" style="display: none;">
                            <i class="bi bi-info-circle"></i> 
                            <span id="formStatusText">Please fill in all required fields for all ring members and provide the private key.</span>
                        </div>
                        
                        <!-- Submit Button -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                                <i class="bi bi-pen"></i> Create Signature
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ring Member Template -->
<template id="memberTemplate">
    <div class="ring-member-card card mb-3" data-member-index="">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="bi bi-person"></i> Ring Member <span class="member-number"></span>
            </h6>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeRingMember(this)">
                <i class="bi bi-trash"></i> Remove
            </button>
        </div>
        <div class="card-body">
            <!-- GitHub Lookup Section -->
            <div class="mb-3 p-3 bg-light rounded">
                <div class="d-flex align-items-center mb-2">
                    <i class="bi bi-github me-2"></i>
                    <strong>Quick Add from GitHub</strong>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">@</span>
                            <input type="text" class="form-control github-username" 
                                   placeholder="Enter GitHub username" 
                                   onkeypress="if(event.key==='Enter') lookupGitHub(this)">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button type="button" class="btn btn-outline-primary w-100" 
                                onclick="testLookup(this)">
                            <i class="bi bi-search"></i> Lookup
                        </button>
                    </div>
                </div>
                <div class="github-result mt-2" style="display: none;">
                    <!-- GitHub lookup results will be displayed here -->
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-control member-name" placeholder="Enter member name" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Organization</label>
                    <input type="text" class="form-control member-organization" placeholder="Enter organization (optional)">
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Key Type *</label>
                    <select class="form-select member-key-type" required>
                        <option value="">Select key type</option>
                        <option value="RSA 1024">RSA 1024 bit</option>
                        <option value="RSA 2048">RSA 2048 bit</option>
                        <option value="RSA 4096">RSA 4096 bit</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Public Key *</label>
                    <textarea class="form-control member-public-key" rows="4" 
                              placeholder="Enter public key in PEM format..." required></textarea>
                </div>
            </div>
        </div>
    </div>
</template>

<script>
let memberCounter = 0;
let currentSignerIndex = 0;
let updateTimeout = null;

document.addEventListener('DOMContentLoaded', function() {
    // Initialize the form
    updateFormStateImmediate();
    
    // Add event listeners
    document.getElementById('signatureForm').addEventListener('submit', validateForm);
    
    // Add event listeners to private key field for real-time updates
    const privateKeyField = document.getElementById('private_key');
    if (privateKeyField) {
        privateKeyField.addEventListener('input', updateFormState); // Debounced for typing
        privateKeyField.addEventListener('change', updateFormStateImmediate); // Immediate for paste/select
    }
    
    // Add event listeners to existing member cards
    const existingMemberCards = document.querySelectorAll('.ring-member-card');
    existingMemberCards.forEach(card => {
        const inputs = card.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.addEventListener('change', function() {
                updateFormStateImmediate(); // Immediate update for change events
                // Update signer options when name or organization changes
                if (input.classList.contains('member-name') || input.classList.contains('member-organization')) {
                    updateSignerOptions();
                }
            });
            input.addEventListener('input', function() {
                updateFormState(); // Debounced update for input events
                // Update signer options when name or organization changes
                if (input.classList.contains('member-name') || input.classList.contains('member-organization')) {
                    updateSignerOptions();
                }
            });
        });
    });
    
    // Add first member by default
    addRingMember();
});

function addRingMember() {
    const container = document.getElementById('ringMembersContainer');
    const template = document.getElementById('memberTemplate');
    const clone = template.content.cloneNode(true);
    
    const memberCard = clone.querySelector('.ring-member-card');
    memberCard.setAttribute('data-member-index', memberCounter);
    
    const memberNumber = clone.querySelector('.member-number');
    memberNumber.textContent = memberCounter + 1;
    
    // Add event listeners to the new member
    const inputs = memberCard.querySelectorAll('input, select, textarea');
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            updateFormStateImmediate(); // Immediate update for change events
            // Update signer options when name or organization changes
            if (input.classList.contains('member-name') || input.classList.contains('member-organization')) {
                updateSignerOptions();
            }
        });
        input.addEventListener('input', function() {
            updateFormState(); // Debounced update for input events
            // Update signer options when name or organization changes
            if (input.classList.contains('member-name') || input.classList.contains('member-organization')) {
                updateSignerOptions();
            }
        });
    });
    
    container.appendChild(clone);
    memberCounter++;
    
    updateFormStateImmediate();
    updateSignerOptions();
}

function removeRingMember(button) {
    const memberCard = button.closest('.ring-member-card');
    memberCard.remove();
    
    // Update member numbers
    const memberCards = document.querySelectorAll('.ring-member-card');
    memberCards.forEach((card, index) => {
        card.setAttribute('data-member-index', index);
        card.querySelector('.member-number').textContent = index + 1;
    });
    
    memberCounter = memberCards.length;
    updateFormStateImmediate();
    updateSignerOptions();
}

function testLookup(button) {
    const usernameInput = button.closest('.row').querySelector('.github-username');
    lookupGitHub(usernameInput);
}

async function lookupGitHub(inputElement) {
    const username = inputElement.value.trim();
    if (!username) {
        showGitHubError(inputElement, 'Please enter a GitHub username');
        return;
    }
    
    const memberCard = inputElement.closest('.ring-member-card');
    const resultDiv = memberCard.querySelector('.github-result');
    const lookupBtn = inputElement.closest('.row').querySelector('button');
    
    // Show loading state
    lookupBtn.disabled = true;
    lookupBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Fetching data from GitHub...</div>';
    
    try {
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const response = await fetch('/signing/github-lookup/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ username: username })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            // Populate the member fields
            const nameInput = memberCard.querySelector('.member-name');
            const orgInput = memberCard.querySelector('.member-organization');
            const keyTypeSelect = memberCard.querySelector('.member-key-type');
            const publicKeyTextarea = memberCard.querySelector('.member-public-key');
            
            nameInput.value = data.name || username;
            orgInput.value = data.organization || '';
            
            if (data.keys && data.keys.length > 0) {
                // Show key selection if multiple keys
                if (data.keys.length === 1) {
                    // Auto-select if only one key
                    const key = data.keys[0];
                    keyTypeSelect.value = key.key_type;
                    publicKeyTextarea.value = key.key;
                    
                    resultDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> 
                            <strong>Success!</strong> Found 1 RSA key for ${data.name} (converted to PEM format)
                        </div>
                    `;
                } else {
                    // Show key selection dropdown
                    let keyOptions = '<option value="">Select a key...</option>';
                    data.keys.forEach((key, index) => {
                        keyOptions += `<option value="${index}">${key.title || `Key ${index + 1}`} (${key.key_type})</option>`;
                    });
                    
                    resultDiv.innerHTML = `
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 
                            <strong>Found ${data.keys.length} keys!</strong> Please select one (all converted to PEM format):
                            <select class="form-select mt-2" onchange="selectGitHubKey(this, ${JSON.stringify(data.keys).replace(/"/g, '&quot;')}, '${memberCard.getAttribute('data-member-index')}')">
                                ${keyOptions}
                            </select>
                        </div>
                    `;
                }
            } else {
                resultDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <strong>No RSA keys found</strong> for ${data.name}. 
                        Please add a public key manually.
                    </div>
                `;
            }
            
            // Update form state
            updateFormState();
            
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> 
                    <strong>Error:</strong> ${data.error}
                </div>
            `;
        }
        
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="bi bi-x-circle"></i> 
                <strong>Network Error:</strong> ${error.message}
            </div>
        `;
    } finally {
        // Reset button state
        lookupBtn.disabled = false;
        lookupBtn.innerHTML = '<i class="bi bi-search"></i> Lookup';
    }
}

function selectGitHubKey(selectElement, keys, memberIndex) {
    const selectedIndex = parseInt(selectElement.value);
    if (selectedIndex >= 0 && selectedIndex < keys.length) {
        const key = keys[selectedIndex];
        const memberCard = document.querySelector(`[data-member-index="${memberIndex}"]`);
        
        const keyTypeSelect = memberCard.querySelector('.member-key-type');
        const publicKeyTextarea = memberCard.querySelector('.member-public-key');
        
        keyTypeSelect.value = key.key_type;
        publicKeyTextarea.value = key.key;
        
        // Update the result message
        const resultDiv = memberCard.querySelector('.github-result');
        resultDiv.innerHTML = `
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i> 
                <strong>Key selected!</strong> ${key.title || `Key ${selectedIndex + 1}`} (PEM format) has been added.
            </div>
        `;
        
        updateFormState();
    }
}

function showGitHubError(inputElement, message) {
    const memberCard = inputElement.closest('.ring-member-card');
    const resultDiv = memberCard.querySelector('.github-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div class="alert alert-danger">
            <i class="bi bi-x-circle"></i> 
            <strong>Error:</strong> ${message}
        </div>
    `;
}

function updateSignerOptions() {
    // Use requestAnimationFrame for better performance
    requestAnimationFrame(() => {
        const signerSelection = document.getElementById('signerSelection');
        const signerOptions = document.getElementById('signerOptions');
        const memberCards = document.querySelectorAll('.ring-member-card');
    
    if (memberCards.length === 0) {
        signerSelection.style.display = 'none';
        return;
    }
    
    signerSelection.style.display = 'block';
    signerOptions.innerHTML = '';
    
    memberCards.forEach((card, index) => {
        const memberName = card.querySelector('.member-name').value || `Member ${index + 1}`;
        const memberOrg = card.querySelector('.member-organization').value;
        const displayName = memberOrg ? `${memberName} (${memberOrg})` : memberName;
        
        const div = document.createElement('div');
        div.className = 'form-check mb-2';
        div.innerHTML = `
            <input class="form-check-input" type="radio" name="signer_radio" 
                   id="signer_${index}" value="${index}" ${index === currentSignerIndex ? 'checked' : ''}>
            <label class="form-check-label" for="signer_${index}">
                <strong>${displayName}</strong>
            </label>
        `;
        
        const radio = div.querySelector('input[type="radio"]');
        radio.addEventListener('change', function() {
            if (this.checked) {
                currentSignerIndex = parseInt(this.value);
                document.getElementById('signerIndex').value = currentSignerIndex;
                updateFormState();
            }
        });
        
        signerOptions.appendChild(div);
    });
    
    // Set initial signer index
    document.getElementById('signerIndex').value = currentSignerIndex;
    }); // End of requestAnimationFrame
}

function updateFormState() {
    // Clear any existing timeout
    if (updateTimeout) {
        clearTimeout(updateTimeout);
    }
    
    // Debounce rapid updates
    updateTimeout = setTimeout(() => {
        updateFormStateImmediate();
    }, 50); // 50ms debounce
}

function updateFormStateImmediate() {
    // Use requestAnimationFrame for better performance
    requestAnimationFrame(() => {
        const memberCards = document.querySelectorAll('.ring-member-card');
        const noMembersAlert = document.getElementById('noMembersAlert');
        const signerSelection = document.getElementById('signerSelection');
        const privateKeySection = document.getElementById('privateKeySection');
        const submitBtn = document.getElementById('submitBtn');
    
    // Show/hide no members alert
    if (memberCards.length === 0) {
        noMembersAlert.style.display = 'block';
        signerSelection.style.display = 'none';
        privateKeySection.style.display = 'none';
        submitBtn.disabled = true;
        return;
    } else {
        noMembersAlert.style.display = 'none';
    }
    
    // Always show signer selection and private key section if there are members
    signerSelection.style.display = 'block';
    privateKeySection.style.display = 'block';
    
    // Validate all members have required fields for submission
    let allValid = true;
    const memberData = [];
    
    memberCards.forEach((card, index) => {
        const name = card.querySelector('.member-name').value.trim();
        const organization = card.querySelector('.member-organization').value.trim();
        const keyType = card.querySelector('.member-key-type').value;
        const publicKey = card.querySelector('.member-public-key').value.trim();
        
        if (!name || !keyType || !publicKey) {
            allValid = false;
        }
        
        memberData.push({
            name: name,
            organization: organization,
            key_type: keyType,
            public_key: publicKey
        });
    });
    
    // Update hidden field
    document.getElementById('memberData').value = JSON.stringify(memberData);
    
    // Enable/disable submit button based on validation
    const privateKey = document.getElementById('private_key').value.trim();
    const canSubmit = allValid && privateKey;
    submitBtn.disabled = !canSubmit;
    
    // Add visual feedback to submit button
    if (canSubmit) {
        submitBtn.classList.remove('btn-secondary');
        submitBtn.classList.add('btn-success');
        submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Create Signature';
    } else {
        submitBtn.classList.remove('btn-success');
        submitBtn.classList.add('btn-secondary');
        if (!allValid) {
            submitBtn.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Complete Required Fields';
        } else if (!privateKey) {
            submitBtn.innerHTML = '<i class="bi bi-key"></i> Enter Private Key';
        } else {
            submitBtn.innerHTML = '<i class="bi bi-plus-circle"></i> Add Ring Members';
        }
    }
    
    // Add visual feedback for incomplete fields
    memberCards.forEach((card, index) => {
        const name = card.querySelector('.member-name').value.trim();
        const keyType = card.querySelector('.member-key-type').value;
        const publicKey = card.querySelector('.member-public-key').value.trim();
        
        if (!name || !keyType || !publicKey) {
            card.classList.add('border-warning');
            card.classList.remove('border-success');
        } else {
            card.classList.add('border-success');
            card.classList.remove('border-warning');
        }
    });
    
    // Show status message
    const statusMessage = document.getElementById('formStatusMessage');
    const statusText = document.getElementById('formStatusText');
    
    if (memberCards.length === 0) {
        statusMessage.style.display = 'none';
    } else if (!allValid) {
        statusMessage.style.display = 'block';
        statusMessage.className = 'alert alert-warning';
        statusText.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Please fill in all required fields (marked with *) for all ring members.';
    } else if (!privateKey) {
        statusMessage.style.display = 'block';
        statusMessage.className = 'alert alert-info';
        statusText.innerHTML = '<i class="bi bi-key"></i> Please provide the private key of the selected signer to create the signature.';
    } else {
        statusMessage.style.display = 'block';
        statusMessage.className = 'alert alert-success';
        statusText.innerHTML = '<i class="bi bi-check-circle"></i> All fields are complete! You can now create the signature.';
    }
    }); // End of requestAnimationFrame
}

function validateForm(event) {
    const memberCards = document.querySelectorAll('.ring-member-card');
    
    if (memberCards.length === 0) {
        event.preventDefault();
        alert('Please add at least one ring member.');
        return false;
    }
    
    // Check if all required fields are filled
    let allValid = true;
    memberCards.forEach((card, index) => {
        const name = card.querySelector('.member-name').value.trim();
        const keyType = card.querySelector('.member-key-type').value;
        const publicKey = card.querySelector('.member-public-key').value.trim();
        
        if (!name || !keyType || !publicKey) {
            allValid = false;
            card.classList.add('border-danger');
        } else {
            card.classList.remove('border-danger');
        }
    });
    
    if (!allValid) {
        event.preventDefault();
        alert('Please fill in all required fields for all ring members.');
        return false;
    }
    
    const privateKey = document.getElementById('private_key').value.trim();
    if (!privateKey) {
        event.preventDefault();
        alert('Please provide the private key of the selected signer.');
        return false;
    }
    
    return true;
}
</script>

<style>
.ring-member-card {
    border: 2px solid #e9ecef;
    transition: border-color 0.3s ease;
}

.ring-member-card:hover {
    border-color: #007bff;
}

.ring-member-card.border-danger {
    border-color: #dc3545 !important;
}

.ring-member-card.border-warning {
    border-color: #ffc107 !important;
}

.ring-member-card.border-success {
    border-color: #198754 !important;
}

.card-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.form-check-input:checked {
    background-color: #007bff;
    border-color: #007bff;
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.alert {
    border-radius: 0.375rem;
}

.form-control:focus, .form-select:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}
</style>
{% endblock %}